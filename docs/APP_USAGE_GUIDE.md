# 은둔마을 앱 사용 가이드

이 문서는 **최종 사용자(참여자)** 와 **운영자(상담사/스태프)** 가 은둔마을 앱을 어떻게 사용하는지 간단히 설명합니다.  
기술적인 내용(스키마, RLS 등)은 `supabase_setup.md`, `PROJECT_SETUP_PROPOSAL.md`를 참고하세요.

---

## 1. 기본 개념 이해하기

- **익명 커뮤니티**
  - 앱 전체에는 은둔청년이 마음을 털어놓을 수 있는 **공개 익명 게시판**이 있습니다.
  - 글/댓글에는 실명이 아니라 **닉네임 또는 랜덤 별칭(예: “따뜻한 고래 3”)** 이 표시됩니다.
- **그룹 익명 게시판**
  - 프로그램/소모임 등 **각 그룹마다 별도의 익명 게시판**을 가질 수 있습니다.
  - 같은 그룹 안에서는 항상 같은 별칭이 유지되어 관계감은 생기지만,  
    그룹 밖에서는 별칭이 공유되지 않아 안전합니다.

---

## 2. 앱 첫 실행 및 로그인

1. 앱을 설치하고 실행하면, 별도의 회원가입 없이 **자동으로 익명 로그인** 됩니다.
2. 이때 Supabase에서 사용자마다 고유한 **UUID**를 배정합니다.
   - 이 UUID는 게시글/댓글의 “작성자”를 서버에서 식별할 때 사용되지만,  
     이용자에게는 보이지 않습니다.

> 참고: 앱을 삭제하거나 다른 기기로 옮기면 새로운 UUID가 생성될 수 있어,  
> 예전에 쓴 글을 “본인 글”로 수정/삭제하지 못할 수 있습니다.

---

## 3. 공개 익명 게시판 사용하기

### 3.1 홈 탭(기본 게시판)

- 하단 탭의 **홈** 화면은 `board_id = 1`인 기본 익명 게시판을 보여줍니다.
- 기능:
  - 게시글 목록 조회 (최신순/인기순 정렬)
  - 검색 (제목/내용 기준)
  - 게시글 상세 보기 및 댓글 작성

### 3.2 글 작성

1. 하단 탭에서 **작성** 버튼(또는 상단/우측에 있는 작성 진입 버튼)을 눌러 글 작성 화면으로 이동합니다.
2. 입력 항목:
   - **제목**: 필수, 최대 100자.
   - **내용**: 필수, 최대 5000자.
   - **닉네임(선택)**:
     - 닉네임을 입력하면 이후에도 기본값으로 기억됩니다.
     - 비워도 글 작성은 가능합니다.
3. 익명/닉네임 표시:
   - 각 게시판에는 익명 정책(`anon_mode`)이 정해져 있습니다.
   - 기본 게시판에서는 보통 다음 중 하나로 동작합니다.
     - `always_anon`: 항상 별칭으로만 표시, 닉네임 토글 없음.
     - `allow_choice`: “이번 글에 내 닉네임을 함께 표시하기” 토글로 선택 가능.
4. 작성 버튼을 누르면 글이 등록되고, 홈 탭에서 확인할 수 있습니다.

---

## 4. 댓글 사용하기

1. 게시글 상세 화면에서 아래쪽 댓글 입력창에 내용을 작성합니다.
2. 검증:
   - 최소 1자 이상, 최대 1000자(기획에 따라 변경 가능).
3. 닉네임/별칭:
   - 댓글도 글과 동일하게 `is_anonymous`, `display_name` 필드를 사용해,
     닉네임 또는 랜덤 별칭으로 표시됩니다.

---

## 5. 그룹 익명 게시판 사용하기

> 그룹 기능은 **프로그램/소모임 등 특정 인원이 참여하는 공간**을 위한 기능입니다.  
> 운영자가 Supabase에서 `groups`, `group_members`, `boards` 를 설정해두어야 동작합니다.

### 5.1 내 그룹 목록 보기

1. 하단 탭 또는 메뉴에서 **그룹** 탭을 선택합니다.
2. `src/app/groups/index.tsx` 화면 기준:
   - 앱은 `group_members` 테이블에서 현재 사용자(`auth.uid()`)가 `status = 'approved'` 인 그룹을 조회합니다.
   - 결과가 카드 리스트로 표시되며, 각 카드를 누르면 해당 그룹의 익명 게시판으로 이동합니다.

### 5.2 그룹 게시판 보기

1. `내 그룹` 화면에서 특정 그룹을 선택하면 `/groups/[groupId]` 화면으로 이동합니다.
2. 이 화면에서는:
   - 상단에 그룹 번호/이름, 게시판 이름, 간단한 설명(`boards.description`)이 표시됩니다.
   - 기본 보드(해당 그룹의 첫 번째 `boards` 레코드)를 대상으로 게시글 목록을 보여줍니다.
   - 최신순/인기순 정렬 탭이 제공됩니다.
3. `006_group_board_rls.sql` 덕분에:
   - `group_members`에 **승인된 멤버(`status='approved'`)만** 이 그룹 게시판 글/댓글을 볼 수 있습니다.

### 5.3 그룹 게시판에서 글/댓글 작성

- 글 작성:
  - 현재 공개 게시판용 작성 화면이 구현되어 있고,
  - 그룹 별 작성 화면은 같은 패턴으로 `groupId`와 `boardId`를 함께 넘겨 주도록 확장할 수 있습니다.
- 댓글 작성:
  - `post/[id].tsx`에서 댓글을 작성할 때,
    - 해당 게시글의 `board_id`, `group_id`를 함께 저장합니다.
    - `resolveDisplayName` 호출 시 `userId`, `boardId`, `groupId`를 seed로 사용해,
      **같은 그룹 안에서는 항상 같은 별칭**이 나오도록 동작합니다.

---

## 6. 랜덤 별칭(익명 캐릭터) 동작 방식

- 별칭은 `src/shared/lib/anonymous.ts`의 `generateAlias(seed)`에서 생성합니다.
- seed 규칙:
  - 그룹 게시판: `userId + ':group:' + groupId`
  - 그룹이 없고 보드만 있을 때: `userId + ':board:' + boardId`
  - 둘 다 없으면: `userId` 또는 `'익명'`
- 예시:
  - 같은 사용자 + 같은 그룹에서 여러 번 글/댓글을 쓰면 항상 같은 별칭 예: “따뜻한 고래 3”.
  - 다른 그룹에서는 seed가 달라지므로 별칭도 달라집니다.

---

## 7. 운영자(스태프) 관점 정리

1. **그룹 만들기**
   - Supabase 대시보드에서 `groups` 테이블에 프로그램/소모임 레코드를 추가합니다.
2. **멤버 등록**
   - 참여자의 `auth.users.id`를 확인해 `group_members`에 추가:
     - `group_id`, `user_id`, `role(owner/member/moderator)`, `status('approved')`.
3. **게시판 생성**
   - `boards` 테이블에 레코드 추가:
     - 공개 커뮤니티: `group_id = NULL`, `visibility='public'`.
     - 그룹 게시판: `group_id = (그룹 id)`, `visibility='private'`, `anon_mode` 선택.
4. **접근 제어**
   - RLS 때문에, `group_members.status != 'approved'` 인 사용자는 그룹 게시판에 접근할 수 없습니다.
   - 가입 대기/탈퇴 처리는 `group_members.status` 값을 변경하는 방식으로 제어할 수 있습니다.

---

## 8. 요약

- 이 앱은 **익명성을 유지하면서도 관계 형성을 돕는 커뮤니티/그룹 게시판**입니다.
- 공개 게시판과 그룹별 게시판 모두:
  - 닉네임(선택) + 랜덤 별칭을 조합해 정체성을 표현하고,
  - Supabase RLS로 **“내가 속한 곳의 글만 보이는”** 안전한 구조를 유지합니다.

향후 신고/안전 장치, 세부 그룹 정책은 별도의 운영 문서에서 다루면 좋습니다. 이 문서는 **참여자와 운영자가 기본 흐름을 이해하는 데 초점**을 맞추고 있습니다.

